# 문장 최적화
- 문장 수준에서 이뤄지는 최적화는 프로그램을 실행할 때 불필요한 명령어를 제거하는 과정
- 반복문
    - 반복문 안에 있는 문장의 비용을 계산할 때는 문장의 비용을 반복 횟수만큼 곱한다.
- 자주 호출되는 함수
    - 함수의 비용을 계산할 때는 함수의 호출 횟수만큼 곱한다.
- 프로그램 전체에서 사용되는 관용구

## 1. 반복문에서 코드 제거하기
- 반복문의 두 부분
    1. 블록으로 둘러싸여 반복 실행되는 문장들
        - C++ 문장에서 계산을 제거하는 일반적인 기법 적용 가능
    2. 반복 횟수를 경정하는 제어문
        - 어떤 의미에서는 오버헤드이므로 최적화 할 수 있는 여지 존재
- 최적화 되지 않은 `for`문 예제
```cpp
char s[] = "This string has many space (0x20) chars. ";
for(size_t i = 0; i < strlen(s); ++i)
    if(s[i] == ' ')
        s[i] = '*';
```
- `for`문에서 문자마다 조건식 i < strlen(s)를 수행한다.
- 알고리즘의 비용은 O(n<sup>2</sup>)이 된다.

### 1. 반복문의 종료값을 캐싱하기
- 위 예제에서 strlen()의 반환값을 초기화 표현식에서 미리 계산해 캐싱하면 성능을 향상할 수 있다.
```cpp
for(size_t i = 0, len = strlen(s); i < len; ++i)
    if(s[i] == ' ')
        s[i] = '*';
```
- 캐싱만 했을 뿐인데 첫번째 코드보다 속도가 약 **20배**정도 빨라진다.

### 2. 더 효율적인 반복문 사용하기
- C++에서 `for`문의 문법
    - `for (초기화 표현식; 조건식; 증감문) 반복해서 실행할 코드`
- 대략적인 컴파일 결과
```
초기화 표현식;
L1: if (!조건식) goto L2;
      반복해서 실행할 코드;
      증감문;
      goto L1;
L2:
```
- 조건식의 결과가 false일 경우 한 번, 증감문을 계산한 후에 한 번, 총 두 번 점프해야 한다.
    - 이 점프로 실행 속도가 저하될 수 있다.

- C++에서 `do-while` 문
    - `do 반보갷서 실행할 코드 while (조건식);`
- 대략적인 컴파일 결과
```
L1: 반복해서 실행할 코드
    if (조건식) goto L1;
```
- `for` 문은 **경우에 따라** 속도가 더 빠른 `do-while`문으로 바꿀 수 있다. (항상 빨라지는것은 아니다)
```cpp
size_t i = 0, len = strlen(s);
do {
    if (s[i] == ' ')
        s[i] = ' ';
    ++i;
} while (i < len);
```
- `for` 문에 비해 비주얼 스튜디오 2010에서는 32% 향상되었지만 비주얼 스튜디오에서는 25% 저하되었다.

### 3. 값을 증가하는 대신 감소하게 하기
- 종료값을 캐싱하는 예제의 증감문에서 값을 증가하는 대신 감소하도록 변형할 수 있다.
- `1에 있는 예제`에서 종료조건인 `strlen()`은 비용이 많이 들기 때문에 증감문을 감소하는쪽으로 변형한다.
```cpp
for (int i = (int)strlen(s)-1; i >= 0; --i)
    if (s[i] == ' ')
        s[i] = '*';
```

### 4. 반복문에서 불변 코드를 제거하기
```cpp
int i, j, x, a[10];
for (i = 0; i < 10; ++i)
{
    j = 100;
    a[i] = i * j * x * x;
}
```
- 위 코드에서 j=100, j * x * x는 반복문에 대해 불변한다.
```cpp
int i, j, x, a[10];
j = 100; // 반복문 밖으로 뺀다.
int tmp = j * x * x; // 미리 계산해 둔다.
for (i = 0; i < 10; ++i)
{
    a[i] = i + tmp;
}
```
- 최신 컴파일러는 위 예제처럼 반복해서 계산하는 불변코드를 찾아 성능을 향상시키고자 코드를 반복문 바깥으로 옮긴다.
- 반복문에 대해 불변인 함수 호출은 개발자가 직접 확인해 옮겨야 한다.

### 5. 반복문에서 불필요한 함수 호출 제거하기
- 순수함수 : 반환값이 함수의 인수에만 의존하며 사이드 이펙트가 없는 함수
    - 반복문 바깥으로 항상 옮길 수 있는 함수이다.
- 시간 절약이 중요하다면 반복문 안에 있는 모든 함수의 호출을 살펴봐야 한다.

### 6. 반복문에서 숨겨진 함수 호출을 제거하기
### 7. 반복문에서 비용이 크고 변화가 느린 호출을 제거하기
### 8. 반복문을 함수 안에 넣어 호출 오버헤드를 줄이기
### 9. 어떤 행동을 하는 횟수를 줄이기
### 10. 그 밖에 다른 기법

## 2. 함수에서 코드 제거하기
### 1. 함수 호출 비용
### 2. 간단한 함수는 인라인으로 선언하기
### 3. 함수를 처음 사용하기 전에 전의하기
### 4. 사용하지 않는 다형성을 제거하기
### 5. 사용하지 않는 인터페이스를 버리기
### 6. 템플릿으로 컴파일 타임에 구현을 선택하기
### 7. PIMPL 관용구를 사용하는 코드를 제거하기
### 8. DLL을 호출하는 코드를 제거하기
### 9. 멤버 함수 대신 정적 멤버 함수를 사용하기
### 10. 가상 소멸자를 기본 클래스로 옮기기

## 3. 표현식 최적화
### 1. 표현식을 단순하게 만들기
### 2. 상수를 함께 모으기
### 3. 비용이 적은 연산자를 사용하기
### 4. 부동 소수점 연산 대신 정수 연산을 사용하기
### 5. double이 float보다 빠를 수 있다
### 6. 반복 계산을 닫힌 형태로 바꾸기

## 4. 제어 흐름 최적화
### 1. if-elseif-else 대신 switch를 사용하기
### 2. switch나 if 대신 가상 함수를 사용하기
### 3. 비용이 들지 않는 예외 처리를 사용하기
